The Hybrid Identity Authentication

Azure AD Connect
    Pre-requisites
        Forest functional level 2003 or higher
        Writable domain controllers
        Win Server 2008 or later
        Ports required: outboud 80/443/5671
        SQL express is used
        Azure AD premium required for Writeback(password, group, connecthealth, etc)
        Based on the Sync object count there is requirement for harddrive size or sql server full edition
    
  Options
      Mulit-Forest Topologies
         SQL Server
         Sync Filtering
         Staging Mode - stand by server for failover
         Sign in - Passthrough/Federation
         Writeback(password, group, connecthealth, etc)
         Customer attribures

SignIn Methods (https://docs.microsoft.com/en-gb/azure/active-directory/hybrid/choose-ad-authn#decision-tree)
Every 30mins for adds/updated to objects
Every 2mins for Password Sync
current configuration Get-ADSyncSchedule

Cloud Authentication                          
    Cloud Only
        only cloud identites, auth is handled compeletly on cluod                                      
    Password Hash Synchronization (PHS) +  Seamless SSO
        Handled on cloud 
        Schuduled to Sync passwords from on-prem to Azure AD
        password hash synchronization process runs every 2 minutes (MD5)
        No requirement for on-prem AD level secuirty policeis
        No sign in requirement not natively supported by Azure AD
        Leaked credentials report on dark web
    Pass-through Authentication (PTA) + Seamless SSO
        Agents are installed - no management, agent makes only outbound calls to the queue (pub-sub model), 
        password requests are put in a queue 
        Enforce on-prem AD level security policies
        Custom Domain name is required
        Use + Password Hash sync for Leaked credentials report on dark web
        
  Federated Authentication
      ADFS
      Customer Providers
        For Federarion Service
        Deploy ADFS proxies on Perimeter
        Smart Card Authentication

Seamless signon
    Setup 
        Azure AD Connect -> Customize -> -> Enable Single Sign-on
        Automatically Creates a computer account(AZUREADSSOACC) for getting Kerberos ticket
        Enable group policy site-to-zone URL
        If doesnt work, it will fall back to asking username password
        User tries to acccess a WebApp -> Redirect Azure AD signin page -> Kerberos service principal names (SPNs) are created to be used during the Azure AD sign-in process
        -> Gets a Kerberos ticket from onprem AD -> ticket forwarded to Azure AD -> Azure AD Decryptes with already know Kerberos Decryption Key
        -> Complete Signin process -> Uses signin to the app
        
SSO/MFA works on all the above.


Need to decide on UserPrincipleName when using Azure AD Connect
Identify Users when users moved around forest
    Uniquely identify users
        Use EmployeeID, dont use name
        Azure Managed ms-DS-ConsistencyGuid(recommened) - instead of objectGUID
        In GALSYNC - detached forests - you can hint/specify Azure AD Connect
        A seperate Dedicated forest -  you can hint/specify Azure AD Connect       

      Matching user in Forests
          No matching - only one forest
          Mail attribute -  GAL sync is deployed between forests and only creates one
          ObjectSID - use in forest topologies to join disabled resource accounts to primary user accounts
          sAMAccountName/mailNickName - use this join duplicate users by account name or nickname
        
Configuration settings
    Configure filtering
        Group-based - only for POC or testing
        Domain-based - select only domains you need
        Organizational Units - you can exclude organizational  (be careful)
        Attribute-based - exclude users
    Exchange Hybrid/MailPublic folders - use exchange for cloud users
    Password Hash Sync as backup for Choosen main authentiation/ Azure AD P2 for leaked credential report
    Password writeback/group/Device - SelfServePasswordReset/ Office365 groups back on prem/ Enable when using device based conditional accessin AD FS with AzureAD Device registration on In-Tune 
    
  Staging Server 
      - Reads everything but doesnt speak to cloud
      - If the event happens, you can use Azure AD Connect wizard to failover
      - Ideally have this in a different region
      
  Configure and install
      - Prevents accidental deletions
      - Feature on by default
      - Cannot export more than 500 deletes
      - Can be configured
      
      
  Links
    aka.ms/auth-options
    aka.ms/aadconnectperf
    aka.ms/deploymentplans/adfs2phs
    aka.ms/deploymentplans/adfs2pta
